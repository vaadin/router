<dom-module id="vaadin-router-route-actions-demos">
  <template>
    <style include="vaadin-component-demo-shared-styles">
      :host {
        display: block;
      }
    </style>

    <h3>Custom Route Actions</h3>
    <p>
      Route resolution is an async operation started by a navigation event, or
      by an explicit <code>render()</code> method call. In that process
      Vaadin.Router goes through the routes config and tries to <em>resolve</em>
      each matching route from the root onwards. The default route resolution
      rule is to create and return an instance of the route's <code>component
      </code> (see the API docs for the <code>setRoutes()</code> method for
      details on other route properties and how they affect the route resolution).
    </p>
    <p>
      Vaadin.Router provides a flexible API to customize the default route
      resolution rule. Each route may have an <code>action</code> functional
      property that defines how exactly that route is resolved. An <code>action
      </code> function may or may not return a value. If it does, that completes
      the resolution pass, and the returned value is what gets rendered.
      Otherwise, the resolution process continues to check the other properties
      of the route and apply the default resolution rules, and then further to
      check other matching routes.
    </p>
    <p>
      The <code>action(context)</code> function receives a <code>context</code>
      parameter with the following properties:
      <ul>
        <li><code>context.pathname</code> [string] the pathname being resolved
          </li>
        <li><code>context.params</code> [object] the route parameters</li>
        <li><code>context.next</code> [function] proceed to resolving the next
          matching route (if any)</li>
        <li><code>context.redirect(path)</code> [function] that creates a redirect data for the path specified.
        This data can be returned from <code>action</code> to perform an actual redirect</li>
        <li><code>context.component(component)</code> [function] that creates a new <code>HTMLElement</code>
          with current context</li>
      </ul>
      The supported return values are
      <ul>
        <li>an instance of <code>HTMLElement</code></li>
        <li>a <em>redirect</em> object, i.e. an <code>object</code> with a
          <code>redirect</code> property that looks like <code><pre>{
  redirect: {
    pathname: '/new/path/:param',
    from: '/old/path/:param',
    params: /* the parameters object (if any) */
  }
}</pre></code></li>
        <li><code>null</code> or <code>undefined</code></li>
      </ul>
    </p>
    <p>
      This demo shows how to use the custom <code>action</code> property to
      collect visit statistics for each route.
    </p>
    <vaadin-demo-snippet id="vaadin-router-route-actions-demo-1" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Home</a>
          <a href="/users">All Users</a>
          <a href="/users/kim">Kim</a>
        </nav>
        <div id="stats"></div>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const urlToNumberOfVisits = {};

          const recordUrlVisit = context => {
            const visitedPath = context.pathname; // get current path
            urlToNumberOfVisits[visitedPath] = (urlToNumberOfVisits[visitedPath] || 0) + 1;
            document.getElementById('stats').innerHTML =
              `Statistics on URL visits: ${JSON.stringify(urlToNumberOfVisits, null, 2)}}`;
            return context.next(); // pass to the next route in the list
          };

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', component: 'x-home-view'},
            {
              path: '/users',
              action: recordUrlVisit, // will be triggered for all children
              children: [
                {path: '/', component: 'x-user-list'},
                {path: '/:user', component: 'x-user-profile'}
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Async Route Resolution</h3>
    <p>
      Since route resolution is async, the <code>action()</code> callback may be
      async as well and return a promise. One use case for that is to create
      a custom route action that makes a remote API call to fetch the data
      necessary to render the route component, before navigating to a route.
    </p>
    <p>
      Note: If a route has both the <code>component</code> and <code>action
      </code> properties, <code>action</code> is executed first and if it does
      not return a result Vaadin.Router proceeds to check the <code>component
      </code> property.
    </p>
    <p>
      This demo shows a way to perform async tasks before navigating to any
      route under <code>/users</code>.
    </p>
    <vaadin-demo-snippet id="vaadin-router-route-actions-demo-2" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Home (no delay on open)</a>
          <a href="/users">All Users (slight delay on open)</a>
          <a href="/users/kim">Kim (slight delay on open)</a>
        </nav>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const pollBackendForChanges = () => {
            return new Promise((resolve, reject) => {
              // this can be an async backend call
              setTimeout(() => resolve(), 1000);
            });
          };

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', component: 'x-home-view'},
            {
              path: '/users',
              action: pollBackendForChanges, // will be triggered for all children
              children: [
                {path: '/', component: 'x-user-list'},
                {path: '/:user', component: 'x-user-profile'}
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Redirecting from an Action</h3>
    <p>
      <code>action()</code> can use its <code>context</code> parameter to influence
      the route resolution result.
      First demo had demonstrated the <code>context.next()</code> usage,
      this demo demonstrates <code>context.redirect(path)</code> method usage
      that allows you to redirect to any other defined route by using its path.
      All the parameters in current context will be passed to the redirect target.
    </p>
    <p>
      Note: If you need only to redirect to another route, defining an action might be an overkill.
      More convenient way is described in <a href="#vaadin-router-redirect-demos">Redirects</a> section.
    </p>
    <vaadin-demo-snippet id="vaadin-router-route-actions-demo-3" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Home</a>
          <a href="/employees/Kim">Route that redirects</a>
          <a href="/users/Kim">Redirect target</a>
        </nav>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const redirect = context => {
            context.params.user += ' (redirected)';
            return context.redirect('/users/:user');
          };

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', component: 'x-home-view'},
            // current route parameters are automatically transferred to redirect target
            {path: '/employees/:user', action: redirect},
            {path: '/users/:user', component: 'x-user-profile'},
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Returning Custom Element as an Action Result</h3>
    <p>
      Another thing that <code>action()</code> can do with <code>context</code>
      parameter is to create a custom element with current context.
      All the parameters in current context will be passed to the rendered element.
    </p>
    <p>
      Note: If the only thing your action does is custom element creation, it can
      be replaced with <code>component</code> property of the route.
      See <a href="#vaadin-router-basic-demos">Getting Started</a> section for examples.
    </p>
    <vaadin-demo-snippet id="vaadin-router-route-actions-demo-4" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Home</a>
          <a href="/users/Kim">Renders stub page</a>
          <a href="/users/admin">Renders user info page</a>
        </nav>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const render = context => {
            if (context.params.user === 'admin') {
              return context.component('x-user-profile');
            }
            const stubElement = context.component('h3');
            stubElement.innerHTML = 'Access denied';
            return stubElement;
          };

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', component: 'x-home-view'},
            // current route parameters are automatically transferred to rendered element
            {path: '/users/:user', action: render},
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>
  </template>
  <script>
    class VaadinRouterRouteActionsDemos extends DemoReadyEventEmitter(ElementDemo(Polymer.Element)) {
      static get is() {
        return 'vaadin-router-route-actions-demos';
      }
    }

    customElements.define(VaadinRouterRouteActionsDemos.is, VaadinRouterRouteActionsDemos);
  </script>
</dom-module>
