<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/lib/mixins/properties-mixin.html">
<link rel="import" href="vaadin-router-mixin.html">

<template>
  <style>
    :host {
      text-decoration: underline;
    }

    :host([hidden]) {
      display: none !important;
    }

    a {
      color: inherit;
      text-decoration: inherit;
    }
  </style>
  
  <a id="anchor">
    <slot></slot>
  </a>
</template>

<script>
  (function() {
    const template = document.currentScript.ownerDocument.querySelector('template');

    /**
      * @memberof Vaadin
      */
    class VaadinRouterLink extends Vaadin.RouterMixin(Polymer.PropertiesMixin(HTMLElement)) {
      static get is() {
        return 'vaadin-router-link';
      }

      static get properties() {
        return {
          href: String,
          active: Boolean
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._onActiveCriteriaChanged();

        this.attachShadow({mode: 'open'})
          .appendChild(template.content.cloneNode(true));
        this._anchor = this.shadowRoot.querySelector('#anchor');
        this._anchor.setAttribute('href', this.href);
        this._anchor.addEventListener('click', this._onClick.bind(this));
      }

      disconnectedCallback() {
        super.disconnectedCallback();
      }

      /**
        * Callback called when any properties with accessors created via
        * `_createPropertyAccessor` have been set.
        *
        * @param {!Object} currentProps Bag of all current accessor values
        * @param {!Object} changedProps Bag of properties changed since the last
        *   call to `_propertiesChanged`
        * @param {!Object} oldProps Bag of previous values for each property
        *   in `changedProps`
        * @return {void}
        * @protected
        */
      _propertiesChanged(currentProps, changedProps, oldProps) {
        super._propertiesChanged(currentProps, changedProps, oldProps);

        if ('href' in changedProps) {
          this._onHrefChanged(currentProps.href, oldProps.href);
          this._onActiveCriteriaChanged();
        }

        if ('active' in changedProps) {
          this._propertyToAttribute('active');
        }
      }

      _onPopstate(event) {
        super._onPopstate();
        this._onActiveCriteriaChanged();
      }

      _onHrefChanged(newValue, oldValue) {
        if (this._anchor && newValue != oldValue) {
          this._anchor.setAttribute('href', newValue);
        }
      }

      _onActiveCriteriaChanged() {
        this.active = this.router && this.router.pathname === this.href;
      }

      _onClick(event) {
        event.preventDefault();
        window.history.pushState(null, document.title, this.href);
        window.dispatchEvent(new PopStateEvent('popstate', {state: null}));
      }
    }

    customElements.define(VaadinRouterLink.is, VaadinRouterLink);

    /**
      * @namespace Vaadin
      */
    window.Vaadin = window.Vaadin || {};
    Vaadin.VaadinRouterLink = VaadinRouterLink;
  })();
</script>
