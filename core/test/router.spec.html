<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-router-core tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../dist/umd/vaadin-router-core.js"></script>
</head>

<body>
  <test-fixture id="outlet">
    <template>
      <div></div>
    </template>
  </test-fixture>

  <script>
    describe('Vaadin.Router', function() {
      this.title = this.title + (window.ShadyDOM ? ' (Shady DOM)' : '');

      var outlet;
      beforeEach(() => {
        // reset the URL
        window.history.pushState(null, null, '/');

        // stamp the test fixture DOM into the page
        outlet = fixture('outlet');
      });

      describe('JS API (basic functionality)', () => {
        describe('new Router(outlet?, options?)', () => {
          it('should work without arguments', () => {
            const router = new Vaadin.Router();
            expect(router).to.be.ok;
          });

          it('should accept a router outlet DOM Node as the 1st argument', () => {
            const router = new Vaadin.Router(outlet);
            const actual = router.getOutlet();
            expect(actual).to.equal(outlet);
          });

          it('should throw if the first argument is truthy but is not valid a DOM Node', () => {
            [
              true,
              42,
              '<slot></slot>',
              [document.body],
              () => document.body
            ].forEach(arg => {
              expect(() => new Vaadin.Router(arg), `${arg}`).to.throw(TypeError);
            });
          });

          it('should accept an options object as the 2nd argument', () => {
            const router = new Vaadin.Router(null, {baseUrl: '/users'});
            expect(router).to.have.property('baseUrl', '/users');
          });
        });

        describe('router.render(pathname)', () => {
          let router;
          beforeEach(() => {
            router = new Vaadin.Router(outlet);
          });
          
          it('should return a promise that resolves to the router outlet DOM element', async () => {
            router.setRoutes([{path: '/', component: 'x-home-view'}]);
            const result = router.render('/');
            expect(result).to.be.a('promise');
            const actual = await result;
            expect(actual).to.equal(outlet);
          });

          it('should return a promise that resolves when the rendered content is appended to the DOM', async () => {
            router.setRoutes([{path: '/', component: 'x-home-view'}]);
            const promise = router.render('/');
            expect(outlet.children).to.have.lengthOf(0);
            await promise;
            expect(outlet.children).to.have.lengthOf(1);
            expect(outlet.children[0].tagName).to.match(/x-home-view/i);
          });

          it('should return a promise that gets rejected on no-match', (done) => {
            const result = router.render('/path/not/defined');
            result
              .then(() => fail('the promise should have been rejected'))
              .catch(() => done());
          });

          it('should create and append a route `component` into the router outlet', async () => {
            router.setRoutes([{path: '/', component: 'x-home-view'}]);
            await router.render('/');
            expect(outlet.children).to.have.lengthOf(1);
            expect(outlet.children[0].tagName).to.match(/x-home-view/i);
          });

          it('should replace any pre-existing content of the router outlet', async () => {
            router.setRoutes([
              {path: '/', component: 'x-home-view'},
              {path: '/users', component: 'x-users-view'},
            ]);
            await router.render('/');
            await router.render('/users');
            expect(outlet.children).to.have.lengthOf(1);
            expect(outlet.children[0].tagName).to.match(/x-users-view/i);
          });
        });
      });
    });
  </script>
</body>
