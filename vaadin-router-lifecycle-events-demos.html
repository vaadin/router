<dom-module id="vaadin-router-lifecycle-events-demos">
  <template>
    <style include="vaadin-component-demo-shared-styles">
      :host {
        display: block;
      }
    </style>

    <h3>Breadcrumbs</h3>
    <p>Suppose, one needs to create a component that shows the currently active
      routes chain where every segment is a link. Even though technically,
      middleware routes and parent groupping routes are also in the active
      routes chain, it does not make much sense to show them to users in a
      breadcrumbs component (because they are not final navigation targers).
    </p>

    <h3>Breadcrumbs / 1: Middleware</h3>
    <p>One way to approach this would be to create a top-level middleware route
      that waits until the pathname is resolved and gets the active route chain
      out of the result.
    </p>

    <p>
      Required features:
      <ul>
        <li>the render result has an <code>activeRoutes</code> property</li>
      </ul>
    </p>

    <p>
      Issues:
      <ul>
        <li>the <code>activeRoutes</code> chain inlcudes routes irrelevant for
          the breadcrumbs</li>
        <li>for the <code>/users/kim</code> path the active routes chain does
          not include the route for the <code>/users</code> prefix</li>
      </ul>
    </p>
    <vaadin-demo-snippet id="vaadin-router-lifecycle-events-demo-1" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Root</a>
          <a href="/users">All Users</a>
          <a href="/users/kim">Kim</a>
        </nav>
        <x-breadcrumbs id="breadcrumbs"></x-breadcrumbs>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const breadcrumbs = document.getElementById('breadcrumbs');
          async function updateBreadcrumbs(context) {
            const result = await context.next();

            // `/` -> [ `/`, `/` ]
            // `/users` -> [ `/`, `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/`, `/users`, `/:user` ]
            const activeRoutes = result.activeRoutes;

            // `/` -> [ `/` ]
            // `/users` -> [ `/`, `/` ]
            // `/users/kim` -> [ `/`, `/:user` ]
            // still not ideal
            const activeComponents = activeRoutes.filter(route => !!route.component);

            breadcrumbs.setPath(activeComponents);
          }

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', action: updateBreadcrumbs},
            {path: '/', component: 'x-home-view'},
            {
              path: '/users',
              children: [
                {path: '/', component: 'x-user-list'},
                {path: '/:user', component: 'x-user-profile'}
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Breadcrumbs / 2: Parent layouts</h3>
    <p>Another approach would be to structure the routes in a special way to
      make it easier to collect breadcrumbs. Each route with children would also
      define its own component, so that children (if any) are inserted into the
      slots.
    </p>

    <p>
      Required features:
      <ul>
        <li>the render result has an <code>activeRoutes</code> property</li>
        <li>a route can have both the <code>children</code> and the
          <code>component</code> properties, which is handled so that both
          HTML elements are created and the element from the child route is
          inserted as a light DOM child into the element from the parent route.
        </li>
      </ul>
    </p>

    <p>
      Issues:
      <ul>
        <li>the <code>activeRoutes</code> chain inlcudes routes irrelevant for
          the breadcrumbs</li>
      </ul>
    </p>
    <vaadin-demo-snippet id="vaadin-router-lifecycle-events-demo-2" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Root</a>
          <a href="/users">All Users</a>
          <a href="/users/kim">Kim</a>
        </nav>
        <x-breadcrumbs id="breadcrumbs"></x-breadcrumbs>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          const breadcrumbs = document.getElementById('breadcrumbs');
          async function updateBreadcrumbs(context) {
            const result = await context.next();

            // `/` -> [ `/`, `/` ]
            // `/users` -> [ `/`, `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/`, `/users`, `/:user` ]
            const activeRoutes = result.activeRoutes;

            // `/` -> [ `/` ]
            // `/users` -> [ `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/users`, `/:user` ]
            // better: at least each segment in the breadcrumbs has a route
            const activeComponents = activeRoutes.filter(route => !!route.component);

            breadcrumbs.setPath(activeComponents);
          }

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', action: updateBreadcrumbs},
            {
              path: '/',
              component: 'x-home-layout',
              children: [
                {path: '/', component: 'x-home-view'},
                {
                  path: '/users',
                  component: 'x-users-layout',
                  children: [
                    {path: '/', component: 'x-user-list'},
                    {path: '/:user', component: 'x-user-profile'}
                  ]
                },
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Breadcrumbs / 3: Parent layouts, breadcrumbs built into the top-level layout</h3>
    <p>A variation of the 2nd option is to include the breadcrumbs into the
      top-level layout component, and use the <code>onAfterEnter</code> lifecycle
      event to access the active routes chain.
    </p>

    <p>
      Required features:
      <ul>
        <li>a route can have both the <code>children</code> and the
          <code>component</code> properties, which is handled so that both
          HTML elements are created and the element from the child route is
          inserted as a light DOM child into the element from the parent route.
        </li>
        <li>route components support lifecycle events (specifically,
          <code>onAfterEnter</code>)</li>
        <li>the <code>activeRoutes</code> property is available to the
          <code>onAfterEnter</code> event hander</li>
      </ul>
    </p>

    <p>
      Issues:
      <ul>
        <li>the <code>activeRoutes</code> chain inlcudes routes irrelevant for
          the breadcrumbs</li>
      </ul>
    </p>
    <vaadin-demo-snippet id="vaadin-router-lifecycle-events-demo-3" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Root</a>
          <a href="/users">All Users</a>
          <a href="/users/kim">Kim</a>
        </nav>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          XHomeLayout.prototype.onAfterEnter = function(context) {
            // `/` -> [ `/`, `/` ]
            // `/users` -> [ `/`, `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/`, `/users`, `/:user` ]
            const activeRoutes = context.activeRoutes;

            // `/` -> [ `/` ]
            // `/users` -> [ `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/users`, `/:user` ]
            // better: at least each segment in the breadcrumbs has a route
            const activeComponents = activeRoutes.filter(route => !!route.component);

            breadcrumbs.setPath(activeComponents);
          }

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', action: updateBreadcrumbs},
            {
              path: '/',
              component: 'x-home-layout',
              children: [
                {path: '/', component: 'x-home-view'},
                {
                  path: '/users',
                  component: 'x-users-layout',
                  children: [
                    {path: '/', component: 'x-user-list'},
                    {path: '/:user', component: 'x-user-profile'}
                  ]
                },
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>

    <h3>Lifecycle Events</h3>
    <p>
      Lifecycle callbacks
      <ul>
        <li><code>onAfterCreated(context)</code> called once after a component
          is created before it is connected to the DOM.</li>
        <li><code>onBeforeEnter(context)</code> called every time a component
          route gets resolved, before inserting the component into the DOM.
          This either happens after the component has just been created, or if
          the route parameters have changed (e.g. a transition from /users/sam
          to /users/kim for the /users/:user route). <strong>This callback could
          trigger a redirect.</strong></li>
        <li><code>onAfterEnter(context)</code> called every time after the
          entire routes chain is resolved and rendered.</li>
        <li><code>onBeforeLeave(context)</code> called every time before
          inactivating the route. <strong>This callback could prevent the
          navigation.</strong> If this compone</li>
        <li><code>onAfterLeave(context)</code> called every time after
          inactivating the route.</li>
      </ul>
    </p>
    <vaadin-demo-snippet id="vaadin-router-lifecycle-events-demo-4" iframe-src="iframe.html">
      <template preserve-content>
        <nav>
          <a href="/">Root</a>
          <a href="/users">All Users</a>
          <a href="/users/kim">Kim</a>
        </nav>
        <div id="outlet"></div>
        <script type="module">
          // import {Router} from '@vaadin/router';
          const {Router} = window.Vaadin;

          XHomeLayout.prototype.onAfterEnter = function(context) {
            // `/` -> [ `/`, `/` ]
            // `/users` -> [ `/`, `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/`, `/users`, `/:user` ]
            const activeRoutes = context.activeRoutes;

            // `/` -> [ `/` ]
            // `/users` -> [ `/`, `/users`, `/` ]
            // `/users/kim` -> [ `/`, `/users`, `/:user` ]
            // better: at least each segment in the breadcrumbs has a route
            const activeComponents = activeRoutes.filter(route => !!route.component);

            breadcrumbs.setPath(activeComponents);
          }

          const router = new Router(document.getElementById('outlet'));
          router.setRoutes([
            {path: '/', action: updateBreadcrumbs},
            {
              path: '/',
              component: 'x-home-layout',
              children: [
                {path: '/', component: 'x-home-view'},
                {
                  path: '/users',
                  component: 'x-users-layout',
                  children: [
                    {path: '/', component: 'x-user-list'},
                    {path: '/:user', component: 'x-user-profile'}
                  ]
                },
              ]
            },
          ]);
        </script>
      </template>
    </vaadin-demo-snippet>
  </template>

  <script>
    class VaadinRouterLifecycleEventsDemos extends DemoReadyEventEmitter(ElementDemo(Polymer.Element)) {
      static get is() {
        return 'vaadin-router-lifecycle-events-demos';
      }
    }

    customElements.define(VaadinRouterLifecycleEventsDemos.is, VaadinRouterLifecycleEventsDemos);
  </script>
</dom-module>
