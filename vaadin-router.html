<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/lib/mixins/properties-mixin.html">
<link rel="import" href="vaadin-history-state-change-mixin.html">

<!-- the core/dist/umd/vaadin-router-core.js file is generated by the 'lib' gulp task -->
<script src="core/dist/umd/vaadin-router-core.js"></script>

<script>
  (function() {
    /**
     * `<vaadin-router>` is a Web Component that renders different content for different URLs. This
     * enables client-side routing. Each content alternative is defined with a `<vaadin-route>` component:
     *
     * ```
     * <vaadin-router>
     *   <vaadin-route path="/">
     *     <template>
     *       <h1>Home</h1>
     *     </template>
     *   </vaadin-route>
     *   <vaadin-route path="/users" component="x-user-list"></vaadin-route>
     * </vaadin-router>
     * ```
     * 
     * @customElement
     * @memberof Vaadin
     * @demo demo/
     */
    class RouterElement extends Vaadin.HistoryStateChangeMixin(Polymer.PropertiesMixin(HTMLElement)) {
      static get is() {
        return 'vaadin-router';
      }

      static get properties() {
        return {
          /** the root URL for this router */
          root: String
        };
      }

      constructor() {
        super();
        this.attachShadow({mode: 'open'});
        // The template needs at least one slot or else shady doesn't distribute
        // see https://github.com/vaadin/vaadin-grid/blob/75fd98ba80567cc34e3e2d6fab8c60292dc96c70/src/vaadin-grid.html#L52
        this.shadowRoot.appendChild(document.createElement('slot'));
        this.__router = new Vaadin.Router();
      }

      connectedCallback() {
        super.connectedCallback();
        this.render();
      }

      /**
       * (override of `Polymer.PropertiesChanged._propertiesChanged`)
       * 
       * Callback called when any properties with accessors created via
       * `_createPropertyAccessor` have been set.
       *
       * @param {!Object} currentProps Bag of all current accessor values
       * @param {!Object} changedProps Bag of properties changed since the last
       *   call to `_propertiesChanged`
       * @param {!Object} oldProps Bag of previous values for each property
       *   in `changedProps`
       * @return {void}
       * @protected
       */
      _propertiesChanged(currentProps, changedProps, oldProps) {
        super._propertiesChanged(currentProps, changedProps, oldProps);

        if (changedProps.root) {
          this.__router.setOptions({baseUrl: changedProps.root});
          this.render();
        }
      }

      /**
       * (override of `Vaadin.HistoryStateChangeMixin.onHistoryStateChanged`)
       * 
       * Callback called when the 'popstate' event is triggered on the window.
       *
       * @param {Object} state the state object associated with the active history entry
       * @param {!string} pathname the current path
       * @return {void}
       */
      onHistoryStateChanged(state, pathname) {
        this.render();
      }

      addRoutes(routes) {
        this.__router.addRoutes(routes);
        this.render();
      }

      removeRoutes(routes) {
        // TODO(vlukashov): implement Router.removeRoutes()
        // this.__router.removeRoutes(routes);
        // this.render();
      }

      render() {
        if (!this.__renderEnqueued) {
          this.__renderEnqueued = Promise.resolve().then(() => this.__render());
        }
        return this.__renderEnqueued;
      }

      __render() {
        this.__renderEnqueued = undefined;
        if (this.__router.getRoutes().length == 0) {
          return;
        }
        
        this.__router
          .resolve(window.location.pathname)
          .then(page => {
            if (this.__outlet) {
              this.__outlet.parentNode.removeChild(this.__outlet);
            }
            this.__outlet = document.createElement('div');
            this.__outlet.appendChild(page);
            this.shadowRoot.appendChild(this.__outlet);
          });
      }
    }

    customElements.define(RouterElement.is, RouterElement);

    /**
     * @namespace Vaadin
     */
    window.Vaadin = window.Vaadin || {};
    Vaadin.RouterElement = RouterElement;
  })();
</script>
