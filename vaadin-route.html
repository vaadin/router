<!--
@license
Copyright (c) 2018 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/lib/mixins/properties-mixin.html">
<link rel="import" href="../polymer/lib/utils/templatize.html">
<link rel="import" href="vaadin-router-mixin.html">

<!-- the lib/path-to-regexp.js file is generated by the 'path-to-regexp' gulp task -->
<script src="lib/path-to-regexp.js"></script>

<script>
  (function() {

    /**
     * `<vaadin-route>` is a Web Component that defines a single route for the
     * `<vaadin-router>` component.
     *
     * ```
     * <vaadin-route path="/users/:user">
     *   <x-user-view></x-user-view>
     * </vaadin-route>
     * ```
     *
     * @polymer
     * @customElement
     * @memberof Vaadin
     * @appliesMixin Vaadin.RouterMixin
     * @appliesMixin Polymer.PropertiesMixin
     */
    class RouteElement extends Vaadin.RouterMixin(Polymer.PropertiesMixin(HTMLElement)) {
      static get is() {
        return 'vaadin-route';
      }

      static get properties() {
        return {
          /** Defines the path served by this route */
          path: String,

          _parameters: Array,
          _regexp: Object,
          _routeTemplate: Object,
          _templateInstance: Object
        };
      }

      connectedCallback() {
        super.connectedCallback();

        this._routeTemplate = this.querySelector('template');
        this._observer = new MutationObserver(() => {
          this._routeTemplate = this.querySelector('template');
        });
        this._observer.observe(this, { childList: true });
      }

      disconnectedCallback() {
        this._observer.disconnect();
        super.disconnectedCallback();
      }

      /**
       * (override of `Polymer.PropertiesChanged._propertiesChanged)
       * 
       * Callback called when any properties with accessors created via
       * `_createPropertyAccessor` have been set.
       *
       * @param {!Object} currentProps Bag of all current accessor values
       * @param {!Object} changedProps Bag of properties changed since the last
       *   call to `_propertiesChanged`
       * @param {!Object} oldProps Bag of previous values for each property
       *   in `changedProps`
       * @return {void}
       * @protected
       */
      _propertiesChanged(currentProps, changedProps, oldProps) {
        super._propertiesChanged(currentProps, changedProps, oldProps);

        if ('path' in changedProps) {
          this._onPathChanged(currentProps.path, oldProps.path);
        }
        if ('_routeTemplate' in changedProps) {
          this._onRouteTemplateChanged(currentProps._routeTemplate, oldProps._routeTemplate);
        }
        if ('_templateInstance' in changedProps || '_regexp' in changedProps) {
          this._onRenderCriteriaChanged();
        }
      }

      _onPopstate(event) {
        super._onPopstate();
        this._onRenderCriteriaChanged();
      }

      _onPathChanged(newValue, oldValue) {
        const keys = [];
        this._regexp = window.PathToRegexp(newValue, keys);
        this._parameters = keys;
      }

      _onRouteTemplateChanged(newValue, oldValue) {
        if (newValue) {
          const TemplateClass = Polymer.Templatize.templatize(newValue);
          this._templateInstance = new TemplateClass({});
        } else {
          this._templateInstance = undefined;
        }
      }

      _onRenderCriteriaChanged() {
        const routeMatch = this.router && this._regexp && this._regexp.exec(this.router.pathname);
        const hasContent = this._templateInstance !== undefined;

        if (routeMatch && hasContent) {
          this._clear();
          this._render(routeMatch);
        } else {
          this._clear();
        }
      }

      _render(match) {
        // make the route parameters available as Polymer properties for the inline template
        this._parameters.forEach((param, i) => {
          this._templateInstance[param.name] = decodeURIComponent(match[i + 1]);
        });

        const outlet = document.createElement('div');
        outlet.setAttribute('class', 'outlet');
        outlet.appendChild(document.importNode(this._templateInstance.root, true));
        this.appendChild(outlet);
      }

      _clear() {
        const outlets = this.querySelectorAll('.outlet');
        for (let i = 0; i < outlets.length; i += 1) {
          this.removeChild(outlets[i]);
        }
      }
    }

    customElements.define(RouteElement.is, RouteElement);

    /**
     * @namespace Vaadin
     */
    window.Vaadin = window.Vaadin || {};
    Vaadin.RouteElement = RouteElement;
  })();
</script>